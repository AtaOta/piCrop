const CropWarp=document.querySelector(".Cropper_Wrapper"),el=document.querySelector(".item"),InpImg=document.getElementsByClassName("inputImg")[0],resizers=document.querySelectorAll(".resizer"),naW=InpImg.naturalWidth,naH=InpImg.naturalHeight;let bounds,rect,leImg,crX1,crY1,curRes,resW,canvasWide,cansvasHigh,scale,ICo=document.querySelector(".Cropping_IMG"),GetCanvas=document.getElementById("canvas"),resizer=document.querySelector(".resizer"),isResizing=!1,initialSize=150,pointX=0,pointY=0,start={x:0,y:0};const piCrop=()=>{bounds=CropWarp.getBoundingClientRect(),rect=el.getBoundingClientRect(),leImg=InpImg.getBoundingClientRect(),resW=resizer.getBoundingClientRect().width,crX1=bounds.left,crY1=bounds.top,el.style.left=`${(CropWarp.clientWidth-el.clientWidth)/2+crX1}px`,el.style.top=`${(CropWarp.clientHeight-el.clientHeight)/2+crY1}px`,el.style.width=`${initialSize}px`,el.style.height=`${initialSize}px`,ICo.style.width=`${CropWarp.clientWidth}px`,ICo.style.top=`${(CropWarp.clientHeight-ICo.clientHeight)/2}px`,scale=1};piCrop();const CanVasDimension=()=>{canvasWide=rect.width,cansvasHigh=rect.height,GetCanvas.width=`${canvasWide}`,GetCanvas.height=`${cansvasHigh}`};CanVasDimension();const DrawingImage=()=>{leImg=InpImg.getBoundingClientRect();let e=(rect=el.getBoundingClientRect()).left-leImg.left,t=rect.top-leImg.top,n=e*(naW/leImg.width),i=t*(naH/leImg.height),o=rect.width*(naW/leImg.width),r=rect.height*(naW/leImg.width);const s=new Image,l=GetCanvas.getContext("2d");s.src=InpImg.src,s.addEventListener("load",()=>{l.drawImage(s,n,i,o,r,0,0,canvasWide,cansvasHigh)})};DrawingImage(),window.addEventListener("resize",()=>{piCrop(),CanVasDimension(),DrawingImage()});const ccmf=(e,t)=>{let n=Math.min(Math.max(bounds.left,rect.left-e),bounds.right-rect.width),i=Math.min(Math.max(bounds.top,rect.top-t),bounds.bottom-rect.height);rect.left<=leImg.left?n=Math.min(Math.max(leImg.left,leImg.left-e),bounds.right-rect.width):rect.right>=leImg.left+leImg.width&&(n=Math.min(Math.max(bounds.left,rect.left-e),leImg.left+leImg.width-rect.width)),rect.top<=leImg.top?i=Math.min(Math.max(leImg.top,leImg.top-t),bounds.bottom-rect.height):rect.bottom>=leImg.top+leImg.height&&(i=Math.min(Math.max(bounds.top,rect.top-t),leImg.top+leImg.height-rect.height)),el.style.left=`${n}px`,el.style.top=`${i}px`,DrawingImage()};function touchstart(e){e.preventDefault();let t=e.touches[0];window.addEventListener("touchmove",o),window.addEventListener("touchend",function e(){window.removeEventListener("touchmove",o);window.removeEventListener("touchend",e);window.removeEventListener("touchstart",touchstart)});let n=t.clientX,i=t.clientY;function o(e){let t=e.touches[0];if(!isResizing){let e=n-t.clientX,o=i-t.clientY;ccmf(e,o),n=t.clientX,i=t.clientY}}}function mousedown(e){e.preventDefault(),el.style.transition="none",window.addEventListener("mousemove",i),window.addEventListener("mouseup",function e(){window.removeEventListener("mousemove",i);window.removeEventListener("mouseup",e)});let t=e.clientX,n=e.clientY;function i(e){e.preventDefault();let i=e;if(!isResizing){let e=t-i.clientX,o=n-i.clientY;ccmf(e,o),t=i.clientX,n=i.clientY}}}el.addEventListener("touchstart",touchstart),el.addEventListener("mousedown",mousedown);const CropperResizer=(e,t,n,i)=>{let o=rect.width,r=rect.height,s=Math.ceil(t.clientX),l=Math.ceil(t.clientY),c=Math.ceil(bounds.right),a=Math.ceil(bounds.left),m=Math.ceil(bounds.top),h=Math.ceil(bounds.bottom);if(0==isResizing)return;c>=leImg.right&&(c=Math.ceil(leImg.right)),a<=leImg.left&&(a=Math.ceil(leImg.left)),m<=leImg.top&&(m=Math.ceil(leImg.top)),h>=leImg.bottom&&(h=Math.ceil(leImg.bottom));let d=c-rect.left,g=Math.max(resW,d),u=Math.min(resW,d),p=h-rect.top,w=Math.max(resW,p),I=Math.min(resW,p),v=rect.right-a,f=Math.max(resW,v),b=Math.min(resW,v),M=rect.bottom-m,W=Math.max(resW,M),C=Math.min(resW,M);e.classList.contains("e")?(o=rect.width-n,s>=c?o=g:s<=rect.left+resW&&(o=u)):e.classList.contains("se")?(o=rect.width-n,r=rect.height-i,s>=c?o=g:s<=rect.left+resW&&(o=u),l>=h?r=w:l<=rect.top+resW&&(r=I)):e.classList.contains("s")?(r=rect.height-i,l>=h?r=w:l<=rect.top+resW&&(r=I)):e.classList.contains("sw")?(o=rect.width+n,r=rect.height-i,s<=a?o=f:s>=rect.right-resW&&(o=b),l>=h?r=w:l<=rect.top+resW&&(r=I),el.style.left=`${rect.right-o}px`):e.classList.contains("w")?(o=rect.width+n,s<=a?o=f:s>=rect.right-resW&&(o=b),el.style.left=`${rect.right-o}px`):e.classList.contains("ne")?(o=rect.width-n,r=rect.height+i,s>=c?o=g:s<=rect.left+resW&&(o=u),l<=m?r=W:l>=rect.bottom-resW&&(r=C),el.style.top=`${rect.bottom-r}px`):e.classList.contains("n")?(r=rect.height+i,l<=m?r=W:l>=rect.bottom-resW&&(r=C),el.style.top=`${rect.bottom-r}px`):e.classList.contains("nw")&&(o=rect.width+n,r=rect.height+i,s<=a?o=f:s>=rect.right-resW&&(o=b),l<=m?r=W:l>=rect.bottom-resW&&(r=C),el.style.top=`${rect.bottom-r}px`,el.style.left=`${rect.right-o}px`),el.style.width=`${o}px`,el.style.height=`${r}px`,CanVasDimension(),DrawingImage()};for(let e of resizers){function touchstart(e){e.preventDefault(),curRes=e.target;let t=e.touches[0],n=t.clientX,i=t.clientY;function o(e){e.preventDefault(),isResizing=!0;let t=e.touches[0],o=n-t.clientX,r=i-t.clientY;CropperResizer(curRes,t,o,r),n=t.clientX,i=t.clientY}window.addEventListener("touchmove",o),window.addEventListener("touchend",function e(){isResizing=!1;window.removeEventListener("touchmove",o);window.removeEventListener("touchend",e)})}function mousedown(e){e.preventDefault(),el.style.transition="none",curRes=e.target;let t=e.clientX,n=e.clientY;function i(e){e.preventDefault(),isResizing=!0;let i=e,o=t-i.clientX,r=n-i.clientY;CropperResizer(curRes,i,o,r),t=i.clientX,n=i.clientY}window.addEventListener("mousemove",i),window.addEventListener("mouseup",function e(){isResizing=!1;window.removeEventListener("mousemove",i);window.removeEventListener("mouseup",e)})}e.addEventListener("touchstart",touchstart),e.addEventListener("mousedown",mousedown)}const setImageTransForm=()=>{leImg=InpImg.getBoundingClientRect(),bounds=CropWarp.getBoundingClientRect(),rect=el.getBoundingClientRect();let e=naH/naW*bounds.width,t=(leImg.width-bounds.width)/2,n=(leImg.height-e)/2,i=(bounds.height-e)/2,o=(Math.ceil(bounds.top)-bounds.top)*scale;pointX>=rect.left-bounds.left+t?pointX=Math.min(Math.max(pointX,leImg.left),rect.left-bounds.left+t):pointX<=rect.right-bounds.right-t&&(pointX=Math.min(Math.max(pointY,leImg.right),rect.right-bounds.right-t)),pointY>=rect.top-bounds.top-i+n+2*o?pointY=Math.min(Math.max(pointY,leImg.top),rect.top-bounds.top-i+n+2*o):pointY<=rect.bottom-bounds.bottom+i-n+4*o&&(pointY=Math.min(Math.max(pointY,leImg.bottom),rect.bottom-bounds.bottom+i-n+4*o)),ICo.style.transform=`translate(${pointX}px, ${pointY}px) scale(${scale})`,DrawingImage()};function IMGmousedown(e){function t(e){e.preventDefault(),pointX=e.clientX-start.x,pointY=e.clientY-start.y,setImageTransForm()}start={x:e.clientX-pointX,y:e.clientY-pointY},window.addEventListener("mousemove",t),window.addEventListener("mouseup",function e(){window.removeEventListener("mousemove",t);window.removeEventListener("mouseup",e)})}function IMGtouchstart(e){let t=e.touches[0];function n(e){let t=e.touches[0];pointX=t.clientX-start.x,pointY=t.clientY-start.y,setImageTransForm()}start={x:t.clientX-pointX,y:t.clientY-pointY},window.addEventListener("touchmove",n),window.addEventListener("touchend",function e(){window.removeEventListener("touchmove",n);window.removeEventListener("touchend",e)})}ICo.addEventListener("mousedown",IMGmousedown),ICo.addEventListener("touchstart",IMGtouchstart);let CWHolder=document.querySelector(".Cropper_Wrappe_Holder");CWHolder.onwheel=function(e){e.preventDefault(),(e.wheelDelta?e.wheelDelta:-e.deltaY)>0?scale+=.1:scale-=.1,scale=Math.min(Math.max(1,scale),5),setImageTransForm(),rect.height>leImg.height&&(el.style.height=`${leImg.height}px`,el.style.top=`${leImg.top}px`,CanVasDimension())};