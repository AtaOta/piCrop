const piCropper=document.querySelector(".pi_ImageCropper"),CropWarp=document.querySelector(".Cropper_Wrapper"),el=document.querySelector(".item"),InputImage=document.getElementsByClassName("inputImg")[0],resizers=document.querySelectorAll(".resizer"),resizer=document.querySelector(".resizer"),naW=InputImage.naturalWidth,naH=InputImage.naturalHeight;let InnerPadding,bounds,rect,leImg,resizerWidth,canvasWide,cansvasHigh,rectStart,rectX,rectY,minRectX,maxRectX,minRectY,maxRectY,isResizing,initialSize,scale,pointX,pointY,start,ResizerOuterXright,ResizerOuterYbottom,ResizerOuterXleft,ResizerOuterYtop,ImageCover=document.querySelector(".Cropping_IMG"),GetCanvas=document.getElementById("canvas");const piCrop=()=>{rectStart={x:0,y:0},rectX=0,rectY=0,isResizing=!1,initialSize=150,pointX=0,pointY=0,start={x:0,y:0},ResizerOuterXright=0,ResizerOuterYbottom=0,ResizerOuterXleft=0,ResizerOuterYtop=0,scale=1,bounds=CropWarp.getBoundingClientRect(),rect=el.getBoundingClientRect(),leImg=InputImage.getBoundingClientRect(),resizerWidth=resizer.getBoundingClientRect().width,InnerPadding=(piCropper.clientWidth-bounds.width)/2,el.style.left=`${(CropWarp.clientWidth-el.clientWidth)/2}px`,el.style.top=`${(CropWarp.clientHeight-el.clientHeight)/2}px`,el.style.width=`${initialSize}px`,el.style.height=`${initialSize}px`,ImageCover.style.width=`${CropWarp.clientWidth}px`,ImageCover.style.top=`${(CropWarp.clientHeight-ImageCover.clientHeight)/2}px`};piCrop();const CanVasDimension=()=>{canvasWide=rect.width,cansvasHigh=rect.height,GetCanvas.width=`${canvasWide}`,GetCanvas.height=`${cansvasHigh}`};CanVasDimension();const DrawingImage=()=>{leImg=InputImage.getBoundingClientRect();let e=(rect=el.getBoundingClientRect()).left-leImg.left,t=rect.top-leImg.top,n=e*(naW/leImg.width),i=t*(naH/leImg.height),r=rect.width*(naW/leImg.width),o=rect.height*(naW/leImg.width);const s=new Image,a=GetCanvas.getContext("2d");s.src=InputImage.src,s.addEventListener("load",()=>{a.drawImage(s,n,i,r,o,0,0,canvasWide,cansvasHigh)})};DrawingImage(),window.addEventListener("resize",()=>{piCrop(),CanVasDimension(),DrawingImage()});const Cropper_Container_Movement=()=>{let e=leImg.left>=bounds.left?leImg.left:bounds.left,t=leImg.left>=bounds.left?leImg.left-bounds.left:0,n=leImg.right<=bounds.right?bounds.right-leImg.right:0;minRectX=-(bounds.right-(bounds.width+initialSize)/2-e-InnerPadding),maxRectX=bounds.width+minRectX-rect.width-t-n,rectX=Math.min(Math.max(rectX,minRectX),maxRectX);let i=leImg.top>=bounds.top?leImg.top:bounds.top,r=leImg.top>=bounds.top?leImg.top-bounds.top:0,o=leImg.bottom<=bounds.bottom?bounds.bottom-leImg.bottom:0;minRectY=-(bounds.bottom-(bounds.height+initialSize)/2-i-InnerPadding),maxRectY=bounds.height+minRectY-rect.height-r-o,rectY=Math.min(Math.max(rectY,minRectY),maxRectY),el.style.transform=`translate(${rectX}px, ${rectY}px)`,CanVasDimension(),DrawingImage()};function touchstart(e){e.preventDefault();let t=e.touches[0];function n(e){let t=e.touches[0];isResizing||(rectX=t.clientX-rectStart.x,rectY=t.clientY-rectStart.y,Cropper_Container_Movement())}rectStart={x:t.clientX-rectX,y:t.clientY-rectY},window.addEventListener("touchmove",n),window.addEventListener("touchend",function e(){window.removeEventListener("touchmove",n);window.removeEventListener("touchend",e);window.removeEventListener("touchstart",touchstart)})}function mousedown(e){function t(e){e.preventDefault();let t=e;isResizing||(rectX=t.clientX-rectStart.x,rectY=t.clientY-rectStart.y,Cropper_Container_Movement())}e.preventDefault(),rectStart={x:e.clientX-rectX,y:e.clientY-rectY},window.addEventListener("mousemove",t),window.addEventListener("mouseup",function e(){window.removeEventListener("mousemove",t);window.removeEventListener("mouseup",e)})}el.addEventListener("touchstart",touchstart),el.addEventListener("mousedown",mousedown);const CropperResizer=(e,t,n,i)=>{let r=bounds.right>=leImg.right?leImg.right:bounds.right,o=bounds.left<=leImg.left?leImg.left:bounds.left,s=bounds.top<=leImg.top?leImg.top:bounds.top,a=bounds.bottom>=leImg.bottom?leImg.bottom:bounds.bottom,c=n-t.clientX,l=i-t.clientY;ResizerOuterXright=Math.ceil(rect.right)>=Math.ceil(r)?ResizerOuterXright+=c:0,ResizerOuterYbottom=Math.ceil(rect.bottom)>=Math.ceil(a)?ResizerOuterYbottom+=l:0,ResizerOuterXleft=Math.round(rect.left)<=Math.round(o)?ResizerOuterXleft+=c:0,ResizerOuterYtop=Math.round(rect.top)<=Math.round(s)?ResizerOuterYtop+=l:0;let d=rect.width-c-ResizerOuterXright;d=Math.min(Math.max(d,resizerWidth),r-rect.left);let m=rect.height-l-ResizerOuterYbottom;m=Math.min(Math.max(m,resizerWidth),a-rect.top);let u=rect.width+c+ResizerOuterXleft;u=Math.min(Math.max(u,resizerWidth),rect.right-o);let h=rect.height+l+ResizerOuterYtop;h=Math.min(Math.max(h,resizerWidth),rect.bottom-s),e.classList.contains("e")?el.style.width=`${d}px`:e.classList.contains("se")?(el.style.width=`${d}px`,el.style.height=`${m}px`):e.classList.contains("s")?el.style.height=`${m}px`:e.classList.contains("sw")?(rectX=t.clientX-rectStart.x,el.style.width=`${u}px`,el.style.height=`${m}px`):e.classList.contains("w")?(rectX=t.clientX-rectStart.x,el.style.width=`${u}px`):e.classList.contains("nw")?(rectX=t.clientX-rectStart.x,rectY=t.clientY-rectStart.y,el.style.width=`${u}px`,el.style.height=`${h}px`):e.classList.contains("n")?(rectY=t.clientY-rectStart.y,el.style.height=`${h}px`):e.classList.contains("ne")&&(rectY=t.clientY-rectStart.y,el.style.width=`${d}px`,el.style.height=`${h}px`),Cropper_Container_Movement()};for(let e of resizers){function touchstart(e){e.preventDefault(),ResizerOuterXright=0,ResizerOuterYbottom=0,ResizerOuterXleft=0,ResizerOuterYtop=0;let t=e.target,n=e.touches[0],i=n.clientX,r=n.clientY;function o(e){isResizing=!0;let n=e.touches[0];CropperResizer(t,n,i,r),i=n.clientX,r=n.clientY}window.addEventListener("touchmove",o),window.addEventListener("touchend",function e(){isResizing=!1;window.removeEventListener("touchmove",o);window.removeEventListener("touchend",e)})}function mousedown(e){ResizerOuterXright=0,ResizerOuterYbottom=0,ResizerOuterXleft=0,ResizerOuterYtop=0,e.preventDefault();let t=e.target,n=e.clientX,i=e.clientY;function r(e){e.preventDefault(),isResizing=!0;let r=e;CropperResizer(t,r,n,i),n=r.clientX,i=r.clientY}window.addEventListener("mousemove",r),window.addEventListener("mouseup",function e(){isResizing=!1;window.removeEventListener("mousemove",r);window.removeEventListener("mouseup",e)})}e.addEventListener("touchstart",touchstart),e.addEventListener("mousedown",mousedown)}const setImageTransForm=()=>{let e=naH/naW*bounds.width,t=(leImg.width-bounds.width)/2,n=(leImg.height-e)/2,i=(bounds.height-e)/2,r=2*scale;pointX>=rect.left-bounds.left+t?pointX=Math.min(Math.max(pointX,leImg.left),rect.left-bounds.left+t):pointX<=rect.right-bounds.right-t&&(pointX=Math.min(Math.max(pointY,leImg.right),rect.right-bounds.right-t)),pointY>=rect.top+r-bounds.top-i+n?pointY=Math.min(Math.max(pointY,leImg.top),rect.top+r-bounds.top-i+n):pointY<=rect.bottom+r-bounds.bottom+i-n&&(pointY=Math.min(Math.max(pointY,leImg.bottom),rect.bottom+r-bounds.bottom+i-n)),ImageCover.style.transform=`translate(${pointX}px, ${pointY}px) scale(${scale})`,DrawingImage()};function IMGmousedown(e){function t(e){pointX=e.clientX-start.x,pointY=e.clientY-start.y,setImageTransForm()}e.preventDefault(),start={x:e.clientX-pointX,y:e.clientY-pointY},window.addEventListener("mousemove",t),window.addEventListener("mouseup",function e(){window.removeEventListener("mousemove",t);window.removeEventListener("mouseup",e)})}function IMGtouchstart(e){e.preventDefault();let t=e.touches[0];function n(e){let t=e.touches[0];pointX=t.clientX-start.x,pointY=t.clientY-start.y,setImageTransForm()}start={x:t.clientX-pointX,y:t.clientY-pointY},window.addEventListener("touchmove",n),window.addEventListener("touchend",function e(){window.removeEventListener("touchmove",n);window.removeEventListener("touchend",e)})}ImageCover.addEventListener("mousedown",IMGmousedown),ImageCover.addEventListener("touchstart",IMGtouchstart);let CWHolder=document.querySelector(".Cropper_Wrappe_Holder");CWHolder.onwheel=function(e){e.preventDefault(),(e.wheelDelta?e.wheelDelta:-e.deltaY)>0?scale+=.1:scale-=.1,scale=Math.min(Math.max(1,scale),3),setImageTransForm()};